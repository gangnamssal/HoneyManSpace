# Static / Media

---

## 1.  Managing static files

- ### 개요

  - **정적 파일**
    - 응답할 때 별도의 처리 없이 **파일 내용을 그대로 보여주면 되는 파일**
      - 사용자의 요청에 따라 내용이 바뀌는 것이 아니라 요청한 것을 그대로 보여주는 파일
    - **파일 자체가 고정**되어 있고, 서비스 중에도 **추가되거나 변경되지 않고 고정**되어 있다.
    - Django에서는 'static files'라고 한다.
      - Django는 staticfiles 앱을 통해 정적 파일과 관련 된 기능을 제공한다.

  

  - **Media File**
    - 미디어 파일
    - 사용자가 웹에서 업로드하는 정적 파일
    - 유저가 업로드 한 모든 정적 파일

  

  - **웹 서버와 정적 파일**
    - 웹 서버의 기본 동작
      - 특정 위치 (URL)에 있는 자원을 요청 받고
      - 응답 (HTTP response)을 처리하고 제공하는 것
      - 웹 서버는 요청 받은 URL로 서버에 존재하는 정적 자원을 제공한다.



- ### Static files 구성

  1.  INSTALLED_APPS에 django.contrib.staticfiles가 포함되어 있는지 확인
  2.  settings.py에서 STATIC_URL을 정의
  3.  앱의 static 폴더에 정적 파일을 위치
     - ex) my_app/static/sample_img.jpg
  4.  템플릿에서 static 템플릿 태그를 사용하여 지정된 경로에 있는 정적 파일의 URL 만들기
     - ![화면 캡처 2022-10-11 151957](C:.\화면 캡처 2022-10-11 151957.png)
       - **{% load %}**
         - load tag
         - 특정 라이브러리, 패키지에 등록된 모든 템플릿 태그와 필터를 로드
       - **{% static '' %}**
         - static tag
         - STATIC_ROOT에 저장된 정적 파일에 연결



- ### Static files 관련 Core Settings

  1. **STATIC_ROOT**
     - Default : None
     - Django 프로젝트에서 사용하는 모든 정적 파일을 한곳에 모아 넣는 경로
     - **collectstatic**이 배포를 위해 정적 파일을 수집하는 디렉토리의 절대 경로
       - **collectstatic**
         - STATIC_ROOT에 django 프로젝트의 모든 정적 파일을 수집
         - ![화면 캡처 2022-10-11 152958](C:.\화면 캡처 2022-10-11 152958.png)
     - **개발 과정에서 setting.py의 DEBUG 값이 True로 설정되어 있으면 해당 값은 작용되지 않는다.**
     - 실 서비스 환경(배포 환경)에서 Django의 모든 정적 파일을 다른 웹 서버가 직접 제공하기 위해 사용
       - **소프트웨어 배포 (Deploy)**
         - 프로그램 및 애플리케이션을 서버와 같은 기기에 설치하여 서비스를 제공하는 것.
         - 클라우드 컴퓨팅 서비스(AWS, Google Cloud ...)에 프로그램 및 애플리케이션을 설치해 제공하는 것.
     - 배포 환경에서는 Django를 직접 실행하는 것이 아니라, 다른 서버에 의해 실행되기 때문에 실행하는 다른 서버는 Django에 내장되어 있는 정적 파일들을 인식하지 못한다. 
  2. **STATICFILES_DIRS**
     - Default : [] (Empty list)
     - **app/static/**  디렉토리 경로를 사용하는 것 (기본 경로) 외에 추가적인 정적 파일 경로 목록을 정의하는 리스트
     - 추가 파일 디렉토리에 대한 전체 경로를 포함하는 문자열 목록으로 작성되어야 한다.
     - ![화면 캡처 2022-10-11 153308](C:.\화면 캡처 2022-10-11 153308.png)
  3. **STATIC_URL**
     - Default : None
     - STATIC_ROOT에 있는 정적 파일을 참조 할 때 사용할 URL
     - 개발 단계에서는 실제 정적 파일들이 저장되어 있는 app/static/ 경로 (기본 경로) 및 STATICFILES_DIRS에 정의된 추가 경로들을 탐색
     - **실제 파일이나 디렉토리가 아니며, URL로만 존재**
     - 비어 있지 않은 값으로 설정 한다면 반드시 slash(/)로 끝나야 한다.
     - ![화면 캡처 2022-10-11 153520](C:.\화면 캡처 2022-10-11 153520.png)



- ### Static files 사용하기

  1. **기본 경로에 있는 static file 가져오기**

     - **(1) app_name/static/app_name 경로에 이미지 파일 배치**

       - ![화면 캡처 2022-10-11 153713](C:.\화면 캡처 2022-10-11 153713.png)

     - **(2) static tag를 사용해 이미지 파일 출력하기**

       - ![화면 캡처 2022-10-11 153835](C:.\화면 캡처 2022-10-11 153835.png)

       

  2. **추가 경로에 있는 static file 가져오기**

     - **(1) 추가 경로 작성**
       - ![화면 캡처 2022-10-11 153935](C:.\화면 캡처 2022-10-11 153935.png)
     - **(2) static/ 경로에 이미지 파일 배치하기 (최상위 경로)**
       - ![화면 캡처 2022-10-11 154021](C:.\화면 캡처 2022-10-11 154021.png)
       - **(3) static tag를 사용해 이미지 파일 출력하기**
         - ![화면 캡처 2022-10-11 154110](C:.\화면 캡처 2022-10-11 154110.png)

---

## 2.  Image Upload

- ### ImageField()

  - 이미지 업로드에 사용하는 모델 필드
  - FileField를 상속받는 서브 클래스로 FileField의 모든 속성 및 메서드를 사용 가능하다.
    - **FileField(upload _to='', storage=None, max_length=100,options)**
      - 파일 업로드에 사용하는 모델 필드
      - 2개의 선택 인자를 가지고 있다.
        1. upload_to
        2. storage
  - 사용자에 의해 업로드 된 객체가 유효한 이미지인지 검사
  - **ImageField 인스턴스는 최대 길이가 100자인 문자열로 DB에 생성**되며,  max_length 인자를 사용하여 최대 길이를 변경 할 수 있다.



- ### FileField / ImageField를 사용하기 위한 단계

  1. setting.py에 **MEDIA_ROOT, MEDIA_URL** 설정

     - **MEDIA_ROOT**
       - Default : '' (Empty string)
       - 사용자가 업로드 한 파일(미디어 파일)들을 보관할 디렉토리의 절대 경로
       - Django는 성능을 위해 업로드 파일은 데이터베이스에 저장하지 않는다.
         - **데이터베이스에 저장되는 것은 "파일 경로"**
       - MEDIA_ROOT는 STATIC_ROOT와 반드시 다른 경로로 지정해야 한다.
       - ![화면 캡처 2022-10-11 154828](C:.\화면 캡처 2022-10-11 154828.png)

     

     - **MEDIA_URL**
       - Default : '' (Empty string)
       - MEDIA_ROOT에서 제공되는 미디어 파일을 처리하는 URL
       - 업로드 된 파일의 주소(URL)를 만들어 주는 역할
         - 웹 서버 사용자가 사용하는 public URL
       - 비어 있지 않은 값으로 설정한다면 반드시 slash(/)로 끝나야 한다.
       - MEDIA_URL은 STATIC_URL과 반드시 다른 경로로 지정해야 한다.
       - ![화면 캡처 2022-10-11 155028](C:.\화면 캡처 2022-10-11 155028.png)

  2. **upload_to** 속성을 정의하여 업로드 된 파일에 사용할 MEDIA_ROOT의 하위 경로를 지정 (선택사항)

     

- ### 개발 단계에서 사용자가 업로드한 미디어 파일 제공하기

  - 사용자로부터 업로드 된 파일이 프로젝트에 업로드 되고나서, 실제로 사용자에게 제공하기 위해서는 업로드 된 파일의 URL이 필요하다.
    - 업로드 된 파일의 URL == settings.MEDIA_URL
    - 위 URL을 통해 참조하는 파일의 실제 위치 == settings.MEDIA_ROOT
  - ![화면 캡처 2022-10-11 155326](C:.\화면 캡처 2022-10-11 155326.png)



- ### CREATE

  - **ImageField 작성**
    - ![화면 캡처 2022-10-11 155906](C:.\화면 캡처 2022-10-11 155906.png)
      - **Model field option**
        1. **blank**
           - Default : False
           - True 인경우 필드를 비워 둘 수 있다.
             - DB에는 ''(빈 문자열)이 저장된다.
           - 유효성 검사에서 사용된다. (is_valid)
        2. **null**
           - Default : False
           - True인 경우 Django는 빈 값을 DB에 NULL로 저장한다.
           - **CharField, TextField와 같은 문자열 기반 필드에는 null 옵션 사용을 피해야 한다.**
    - **ImageField를 사용하려면 반드시 Pillow 라이브러리가 필요하다.**
      - ![화면 캡처 2022-10-11 160232](C:.\화면 캡처 2022-10-11 160232.png)
        - **Pillow**
          - 광범위한 파일 형식 지원, 효율적이고 강력한 이미지 처리 기능을 제공하는 라이브러리
          - 이미지 처리 도구를 위한 견고한 기반을 제공한다.
    - ![화면 캡처 2022-10-11 160358](C:.\화면 캡처 2022-10-11 160358.png)
      - **파일 or 이미지 업로드 시에는 form 태그에 enctype 속성을 변경해야 한다.**
        - **enctype(인코딩) 속성 값**
          1. aplication/x-www-form-urlencoded
             - 기본 값
             - 모든 문자 인코딩
          2. multipart/form-data
             - 파일/이미지 업로드 시에 반드시 사용해야 한다.
             - 전송되는 데이터의 형식을 지정한다.
             - <input type='file'>을 사용할 경우 사용
          3. text/plain
    - ![화면 캡처 2022-10-11 160625](C:.\화면 캡처 2022-10-11 160625.png)
      - **파일 or 이미지는 request의 POST 속성 값으로 넘어가지 않고 FILES 속성 값에 담겨서 넘어간다.**



- ### READ

  - 업로드 된 파일의 상대 URL은 Django가 제공하는 url 속성을 통해 얻을 수 있다.
  - ![화면 캡처 2022-10-11 160749](C:.\화면 캡처 2022-10-11 160749.png)
    - **article.image.url - 업로드 파일의 경로**
    - **article.image - 업로드 파일의 파일 이름**



- ### UPDATE

  - ![화면 캡처 2022-10-11 160915](C:.\화면 캡처 2022-10-11 160915.png)
  - ![화면 캡처 2022-10-11 160936](C:.\화면 캡처 2022-10-11 160936.png)



- ### upload_to

  - **사용자 지정 업로드 경로와 파일 이름 설정하기**
    1. **문자열 값이나 경로 지정 방법**
       - upload_to 인자에 새로운 이미지 저장 경로를 추가 후 migration 진행
       - ![화면 캡처 2022-10-11 161150](C:.\화면 캡처 2022-10-11 161150.png)
       - ![화면 캡처 2022-10-11 161217](C:.\화면 캡처 2022-10-11 161217.png)
         - **MEDIA_ROOT 이후 경로가 추가 되는 것**
       - **단순 문자열 뿐만 아니라 파이썬 time 모듈의 strftime() 형식도 포함될 수 있으며, 파일 업로드 날짜/시간으로 대체 된다.**
         - ![화면 캡처 2022-10-11 161352](C:.\화면 캡처 2022-10-11 161352.png)
         - ![화면 캡처 2022-10-11 161432](C:.\화면 캡처 2022-10-11 161432.png)
    2. **함수 호출 방법**
       - **upload_to는 독특하게 함수처럼 호출이 가능하며 해당 함수가 호출 되면서 반드시 2개의 인자를 받는다.**
       - ![화면 캡처 2022-10-11 161523](C:.\화면 캡처 2022-10-11 161523.png)
       - ![화면 캡처 2022-10-11 161722](C:.\화면 캡처 2022-10-11 161722.png)
         - 1. **instance**
              - FileField가 정의된 모델의 인스턴스
              - 대부분 이 객체는 아직 데이터베이스에 저장되기 전이므로 아직 PK 값이 없을 수 있으니 주의해야 한다.
           2. **filename**
              - 기존 파일 이름

---

## 3. Image Resizing

- ### 사전 준비

  - django-imagekit 모듈 설치 및 등록
    - ![화면 캡처 2022-10-11 161814](C:.\화면 캡처 2022-10-11 161814.png)



- ### 썸네일 만들기

  1. **원본 이미지 저장 x**
     - ![화면 캡처 2022-10-11 161936](C:.\화면 캡처 2022-10-11 161936.png)
  2. **원본 이미지 저장 O**
     - ![화면 캡처 2022-10-11 162008](C:.\화면 캡처 2022-10-11 162008.png)
     - ![화면 캡처 2022-10-11 162059](C:.\화면 캡처 2022-10-11 162059.png)
       - **이미지가 출력되는 다른 detail 페이지에 이동 할 떄마다 썸네일이 생성된다.**

---

## 4. QuerySet API Advanced

- **.count()**

  - QuerySet과 일치하는 데이터베이스의 개체 수를 나타내는 정수를 반환
  - ![화면 캡처 2022-10-11 162301](C:.\화면 캡처 2022-10-11 162301.png)

  

- **order_by()**

  - .order_by(*fields)
  - QuerySet의 정렬을 재정의
  - **기본적으로 오름차순으로 정렬, 필드명에 '-'(하이픈)을 작성하면 내림차순으로 정렬**
  - **인자로 '?'를 입력하면 랜덤으로 정렬**
  - ![화면 캡처 2022-10-11 162443](C:.\화면 캡처 2022-10-11 162443.png)
  - ![화면 캡처 2022-10-11 162906](C:.\화면 캡처 2022-10-11 162906.png)



- **values()**

  - .values(*fields, **expressions)
  - 모델 인스턴스가 아닌 딕셔너리 요소들을 가진 QuerySet을 반환
  - *fields는 선택인자이며 조회하고자 하는 필드명을 가변인자로 받는다.
    - **필드를 지정하면 각 딕셔너리에는 지정한 필드에 대한 key와 value 만을 출력**
    - 입력하지 않을 경우 각 딕셔너리에는 레코드의 모든 필드에 대한 key와 value를 출력
  - ![화면 캡처 2022-10-11 162735](C:.\화면 캡처 2022-10-11 162735.png)

  

- **distinct()**

  - 중복없이 조회하기
  - ![화면 캡처 2022-10-11 163113](C:.\화면 캡처 2022-10-11 163113.png)

  

- **filter()**

  - 특정 조건에서 조회하기
  - ![화면 캡처 2022-10-11 163309](C:.\화면 캡처 2022-10-11 163309.png)



- **Field lookups**
  - SQL WHERE 절의 상세한 조건을 지정하는 방법
  
  - QuerySet 메서드 filter(), exclude() 및 get()에 대한 키워드 인자로 사용된다.
  
  - **문법 규칙**
    - 필드명 뒤에 "double-underscore" 이후 작성
      - ![화면 캡처 2022-10-11 163501](C:.\화면 캡처 2022-10-11 163501.png)



- **exclude()**
  - exclude(**kwargs)
  - 주어진 매개변수와 일치하지 않는 객체를 포함하는 QuerySet 반환
  - ![화면 캡처 2022-10-11 170238](C:.\화면 캡처 2022-10-11 170238.png)



- **slicing**
  - python의 기능 중 하나 인 slicing을 사용할 수 있다.
  - ![화면 캡처 2022-10-11 170411](C:.\화면 캡처 2022-10-11 170411.png)
    - **나이 순으로 정렬한 뒤 10명만 조회**



- **'Q' object**
  - ![화면 캡처 2022-10-11 170517](C:.\화면 캡처 2022-10-11 170517.png)
  - 기본적으로 filter() 와 같은 메서드의 키워드 인자는 AND statement를 따른다.
  - 만약 더 복잡한 쿼리를 실행해야 하는 경우가 있다면 Q 객체가 필요하다.
  - ![화면 캡처 2022-10-11 170710](C:.\화면 캡처 2022-10-11 170710.png)
  - ![화면 캡처 2022-10-11 170807](C:.\화면 캡처 2022-10-11 170807.png)



- **aggregate()**
  - 전체 queryset에 대한 값을 계산
  - 특정 필드 전체의 합, 평균, 개수 등을 계산할 때 사용
  - **딕셔너리를 반환**
  - ![화면 캡처 2022-10-11 171054](C:.\화면 캡처 2022-10-11 171054.png)
  - ![화면 캡처 2022-10-11 171153](C:.\화면 캡처 2022-10-11 171153.png)



- **annotate()**
  - 쿼리의 각 항목에 대한 요약 값을 계산
  - SQL의 GROUP BY에 해당한다.
  - ![화면 캡처 2022-10-11 171331](C:.\화면 캡처 2022-10-11 171331.png)
  - ![화면 캡처 2022-10-11 171422](C:.\화면 캡처 2022-10-11 171422.png)
  - ![화면 캡처 2022-10-11 171529](C:.\화면 캡처 2022-10-11 171529.png)
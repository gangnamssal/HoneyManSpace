# 데이터베이스 관계(M:N)

---

## 1. Many to many relationship

- ### 개요

  - **데이터 모델링**
    - 주어진 개념으로부터 논리적인 데이터 모델을 구성하는 작업
    - 물리적인 데이터베이스 모델로 만들어 고객의 요구에 따라 특정 정보 시스템의 데이터베이스에 반영하는 작업
  - **target model**
    - 관계 필드를 가지지 않는 모델
  - **source model**
    - 관계 필드를 가진 모델



- ### ManyToManyField

  - ManyToManyField(to, **options)
  - **다대다 (M:N) 관계 설정 시 사용하는 모델 필드**
  - 하나의 필수 위치인자가 필요하다. (M:N 관계로 설정할 모델 클래스)
  - ![화면 캡처 2022-10-12 103141](C:.\화면 캡처 2022-10-12 103141.png)
  - 모델 필드의 RelatedManager를 사용하여 관련 개체를 추가, 제거, 생성 등이 가능하다.
    - add(), romove(), create(), clear()...
  - **데이터베이스에서의 표현**
    - Django는 다대다 관계를 나타내는 중개 테이블을 만든다.
    - **테이블 이름은 ManyToManyField 이름과 이를 포함하는 모델의 테이블 이름을 조합하여 생성된다.**
    - **'db_table'** arguments를 사용하여 중개 테이블의 이름을 변경할 수 있다.



- ### related_name

  - target model이 source model을 참조할 때 사용할 manager name
  - ForeignKey의 related_name과 동일하다.
  - ![화면 캡처 2022-10-12 103141](C:.\화면 캡처 2022-10-12 103141.png)



- ### through

  - 중개 테이블을 직접 작성하는 경우, through 옵션을 사용하여 중개 테이블을 나타내는 Django 모델을 지정한다.
  - 일반적으로 중개 테이블에 추가 데이터를 사용하는 다대다 관계와 연결하려는 경우에 사용된다.
  - ![화면 캡처 2022-10-12 105656](C:.\화면 캡처 2022-10-12 105656.png)
  - ![화면 캡처 2022-10-12 105622](C:.\화면 캡처 2022-10-12 105622.png)
  - ![화면 캡처 2022-10-12 105635](C:.\화면 캡처 2022-10-12 105635.png)



- ### symmetrical

  - 기본 값 : True
  - ManyToManyField가 동일한 모델(on self)을 가리키는 정의에서만 사용한다.
  - ![화면 캡처 2022-10-12 104024](C:.\화면 캡처 2022-10-12 104024.png)
  - **True일 경우**
    - _set 매니저를 추가 하지 않는다.
    - source 모델의 인스턴스가 target 모델의 인스턴스를 참조하면 자동으로 target 모델 인스턴스도 source 모델 인스턴스를 자동으로 참조하도록 한다. (대칭)
  - **False일 경우**
    - 대칭을 원하지 않는 경우 사용
    - ex) 인스타그램 - Follow 기능



- ### Related Manager

  - N:1 혹은 M:N 관계에서 사용 가능한 문맥(context)
  - Django는 모델 간 N:1 혹은 M:N 관계가 설정되면 역참조시에 사용할 수 있는 manager를 생성
  - 같은 이름의 메서드여도 각 관계(N:1, M:N)에 따라 다르게 사용 및 동작된다.
    - **N:1 에서는 targer 모델 객체만 사용 가능하다.**
    - **M:N 관계에서는 관련된 두 객체에서 모두 사용 가능하다.**
  - 메서드 종류
    - add(), remove(), create(), clear(), set() ...



- ### methods

  - many-to-many relationships에서의 동작만 정리
  - **add()**
    - 지정된 객체를 관련 객체 집합에 추가
    - **이미 존재하는 관계에 사용하면 관계가 복제되지 않는다.**
    - 모델 인스턴스, 필드 값(PK)을 인자로 허용한다.
  - **remove()**
    - 관련 객체 집합에서 지정된 모델 개체를 제거한다.
    - 내부적으로 QuerySet.delete()를 사용하여 관계가 삭제된다.
    - 모델 인스턴스, 필드 값(PK)을 인자로 허용한다.



- ### 중개 테이블 필드 생성 규칙

  1. **소스(source model) 및 대상(target model) 모델이 다른 경우**
     - id
     - <containing_model>_id
     - <other_model>_id
     - ![화면 캡처 2022-10-12 104859](C:.\화면 캡처 2022-10-12 104859.png)
  2. **ManyToManyField가 동일한 모델을 가리키는 경우**
     - id
     - from _ <model> _ id
     - to_ <model> _ id

---

## 2. M : N (Article-User)

- ### M:N 관계를 이용한 Like 기능 구현하기

  1. **ManyToManyField 작성**
     - ![화면 캡처 2022-10-12 110425](C:.\화면 캡처 2022-10-12 110425.png)
       - **migration을 하면 에러가 발생한다.**
         - like_users 필드 생성 시 자동으로 역참조에는 **.article_set 매니저가 생성**된다.
         - 그러나 이전 **N : 1 (Article-User) 관계에서 이미 해당 매니저를 사용 중이다.**
           - user.article_set.all() : 해당 유저가 작성한 모든 게시글 조회
           - **user가 작성한 글과 user가 좋아요를 누른 글을 구분할 수 없다.**
         - **user와 관계된 ForeignKey 혹은 ManyToManyField 중 하나에 related_name을 작성해야 한다.**
         - ![화면 캡처 2022-10-12 110920](C:.\화면 캡처 2022-10-12 110920.png)
  2. **url 및 view 함수 작성**
     - ![화면 캡처 2022-10-12 133212](C:.\화면 캡처 2022-10-12 133212.png)
       - **.exists()**
         - **QuerySet에 결과가 포함되어 있으면 True**를 반환, **그렇지 않으면 False**를 반환
         - **큰 QuerySet에 있는 특정 개체의 존재와 관련된 검색에 유용하다.**
  3. **index 템플릿 수정**
     - ![화면 캡처 2022-10-12 135116](C:.\화면 캡처 2022-10-12 135116.png)

---

## 3. M : N (User-User)

- ### Follow 구현하기

  1. **Profile 페이지 구현**
     - ![화면 캡처 2022-10-12 141359](C:.\화면 캡처 2022-10-12 141359.png)
     - ![화면 캡처 2022-10-12 141443](C:.\화면 캡처 2022-10-12 141443.png)
     - ![화면 캡처 2022-10-12 141524](C:.\화면 캡처 2022-10-12 141524.png)
  2. **Follow 구현**
     1. ![화면 캡처 2022-10-12 144923](C:.\화면 캡처 2022-10-12 144923.png)
     2. ![화면 캡처 2022-10-12 145108](C:.\화면 캡처 2022-10-12 145108.png)
     3. ![화면 캡처 2022-10-12 145142](C:.\화면 캡처 2022-10-12 145142.png)

---

## 4. Fixtures

- **Django에서는 fixtures를 사용해 앱에 초기 데이터를 제공할 수 있다**

- ### Providing data with fixtures

  - **fixtures**
    - Django가 데이터베이스로 가져오는 방법을 알고 있는 데이터 모음

  

  - **fixtures 기본 경로**
    - app_name/fixtures/
    - Django는 설치된 모든 app의 디렉토리에서 fixtures 폴더 이후의 경로로 fixtures 파일을 찾는다.

  

  - **fixtures 생성 및 로드**
    - **생성 (추출)**
      - **dumpdata**
        - 응용 프로그램과 관련된 데이터베이스의 모든 데이터를 표줄 출력으로 출력
        - **여러 모델을 하나의 json 파일로 만들 수 있다.**
        - **manage.py와 동일한 위치에 data가 담긴 articles.json 파일이 생성**된다.
        - dumpdata의 출**력 결과물은 loaddata의 입력으로 사용**된다.
        - ![화면 캡처 2022-10-12 155115](C:.\화면 캡처 2022-10-12 155115.png)
        - ![화면 캡처 2022-10-12 155148](C:.\화면 캡처 2022-10-12 155148.png)
        - 만들어진 json 파일을 app 안에 fixtures/ 폴더를 만들어서 넣는다.
    - **로드**
      - **loaddata**
        - fixtures의 내용을 검색하여 데이터베이스로 로드
        - **migrate 후에 load를 해야한다.**
        - ![화면 캡처 2022-10-12 155911](C:.\화면 캡처 2022-10-12 155911.png)
          - 여러 개의 파일을 한꺼번에 하는 방법은 띄어쓰기 후 파일 이름을 쓰면 된다.
          - **한꺼번에 로드를 하면 순서는 상관이 없지만, 하나씩 로드를 하면 순서가 중요하다.**



- ### Improve Query

  - ### annotate

    - ![화면 캡처 2022-10-12 161909](C:.\화면 캡처 2022-10-12 161909.png)
    - ![화면 캡처 2022-10-12 161941](C:.\화면 캡처 2022-10-12 161941.png)

  

  - ### select_related

    - **1:1 또는 N:1 참조 관계에서 사용**
    - SQL에서 INNER JOIN 절을 활용
      - SQL의 INNER JOIN 을 사용하여 참조하는 테이블의 일부를 가져오고, SELECT FROM을 통해 관련된 필드들을 가져온다.
    - ![화면 캡처 2022-10-12 161832](C:.\화면 캡처 2022-10-12 161832.png)

  

  - ### prefetch_related

    - **1:1 또는 N:1에서 역참조일 때 사용한다.**
    - ![화면 캡처 2022-10-12 162142](C:.\화면 캡처 2022-10-12 162142.png)
